<!DOCTYPE HTML>
<html lang="en-US" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>C-Style Bitfields - A User’s Guide to the Ferrilab Project</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A more thorough exploration of Ferrilab’s crates.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../.././guide/assets/mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">A User’s Guide to the Ferrilab Project</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ferrilab/ferrilab" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="bitfields"><a class="header" href="#bitfields">Bitfields</a></h1>
<p><code>bitvec</code>’s more technically-interesting capability is that it provides
load/store memory access behaviors that allow you to write values into, and read
them back out of, any <code>BitSlice</code> in memory rather than being constrained to
well-formed references to well-typed memory.</p>
<p>This is useful for the de/construction of packed memory buffers, such as
transporting data through I/O protocols.</p>
<pre><code class="language-admonish warning">**AUTHOR’S NOTE**: If you are using `bitvec` to do **anything** related to the
underlying memory representation of a bit-buffer, you **must** read this
chapter, and **all** of the API docs of [`bitvec::field`] and its contents,
**in their entirety**.

I have written extensively, and yet still insufficiently, about the intricacies
involved in operating the `BitField` trait correctly. If you skim this
documentation, you *will* have unexpected behavior, you *will* get frustrated
with me for writing a bad library, you *will* file an issue about it, and I will
*probably* tell you that the behavior is correct and that I already addressed it
in the documentation.

It took me a long time to think about and a long time to write. It should take
you *also* a long time to read and a long time to think about.
</code></pre>
<p>All of this behavior is contained in the <code>BitField</code> trait. Let’s explore that:</p>
<pre><code class="language-rust no_run">//  bitvec::field

pub trait BitField {
  fn load&lt;M&gt;(&amp;self) -&gt; M;
  fn store&lt;M&gt;(&amp;mut self, value: M);
}

impl&lt;T&gt; BitField for BitSlice&lt;T, Lsb0&gt; {
  fn load&lt;M&gt;(&amp;self) -&gt; M { /* snip */ }
  fn store&lt;M&gt;(&amp;mut self, value: M) { /* snip */ }
}

impl&lt;T&gt; BitField for BitSlice&lt;T, Msb0&gt; {
  fn load&lt;M&gt;(&amp;self) -&gt; M { /* snip */ }
  fn store&lt;M&gt;(&amp;mut self, value: M) { /* snip */ }
}</code></pre>
<p>The actual trait is more complex than this, and will be visited later. The
important part, right now, is that <code>BitField</code> allows you to load values out of
<code>BitSlice</code>s and store values into them. Furthermore, it is implemented
<em>specifically</em> on <code>BitSlices</code> that use the bit orderings provided by <code>bitvec</code>,
and is <strong>not</strong> generic over all orderings.</p>
<p>While <code>bitvec</code> could in theory provide a default implementation for all
<code>&lt;O: BitOrder&gt;</code>, this would by necessity have the most pessimal possible
performance, and the lack of specialization for overlapping trait
implementations means that faster performance can never be written.</p>
<p>The downside of the two specific implementations is that Rust <em>coherence</em> rules
forbid implementation of a <code>bitvec</code> trait, on a <code>bitvec</code> type, parameterized
with a local, but non-<code>bitvec</code>, implementor of <code>BitOrder</code>. On the off chance
that you find yourself writing a new <code>BitOrder</code> implementor, file an issue.</p>
<p>The <code>M</code> type parameter on the load and store methods is bounded by funty’s
<code>Integral</code>, trait. It can store any unsigned <em>or signed</em> integer at any partial
width. This parameterization allows you to combine any integer type for transfer
with any integer type for storage, rather than being restricted to only
transferring <code>T</code> data into and out of a <code>BitSlice&lt;T, _&gt;</code>.</p>
<p>Unfortunately, adding a second integer type parameter is not the only
complication to the <code>BitStore</code> memory model. There is also a second dimension of
segment ordering. <code>bitvec</code> tries to make explicitly clear that the <code>Lsb0</code> and
<code>Msb0</code> types refer only to the ordering of <em>bits</em> within registers, and not to
the ordering of <em>bytes</em> within registers. However, when the integer bit-sequence
being stored or stored does not fit within one register of the storage
<code>BitSlice</code>, it must be split into multiple segments, and those segments must
somehow be ordered in memory.</p>
<h2 id="segment-orderings"><a class="header" href="#segment-orderings">Segment Orderings</a></h2>
<pre><code class="language-admonish warning">Author’s Note: **READ THIS**. I have received *several* issues about this exact
concept. *It is not obvious*.
</code></pre>
<p>There are two segment orderings: little-endian and big-endian. You may select
the segment endianness you prefer by using the <code>_le</code> or <code>_be</code> suffix,
respectively, on the <code>.load()</code> and <code>.store()</code> methods. The unsuffixed method is
an alias for the endianness of your processor: <code>_be</code> on big-endian targets, and
<code>_le</code> on little-endian. This is a <strong>convenience only</strong>. If you are writing I/O
buffers, you should really use the explicitly-named methods.</p>
<p>Let us imagine a <code>BitSlice&lt;u8, Lsb0&gt;</code> used to store a <code>u16</code> that is misaligned,
and thus stored in three successive bytes. This algorithm is true for all
circumstances where the stored region occupies more than one register of the
backing slice, but smaller examples are simpler to draw.</p>
<p>This diagram uses <code>0</code> to refer to the least significant bit, and <code>7</code> to refer to
the most significant bit. The first row shows bytes of memory, the second row
shows the bit indices in memory used by <code>.store_le()</code>, and the third row shows
the bit indices in memory used by <code>.store_be()</code>.</p>
<pre><code class="language-text">[ 7 6 5 4 3 2 1 0 ] [ 7 6 5 4 3 2 1 0 ] [ 7 6 5 4 3 2 1 0 ]
  3 2 1 0             b a 9 8 7 6 5 4             f e d c
  f e d c             b a 9 8 7 6 5 4             3 2 1 0
</code></pre>
<p><code>.store_le()</code> places the least significant segment in the low address, while
<code>.store_be()</code> places the most significant segment in the low address. The
ordering of bits within a segment is <em>always</em> preserved, no matter which
ordering parameter is used by the <code>BitSlice</code>.</p>
<p>Here is the same example, but using the <code>Msb0</code> bit ordering instead. Again, the
second row uses <code>.store_le()</code>, and the third row uses <code>.store_be()</code>.</p>
<pre><code class="language-text">[ 7 6 5 4 3 2 1 0 ] [ 7 6 5 4 3 2 1 0 ] [ 7 6 5 4 3 2 1 0 ]
          3 2 1 0     b a 9 8 7 6 5 4     f e d c
          f e d c     b a 9 8 7 6 5 4     3 2 1 0
</code></pre>
<p>The only change is in how the segments are placed into memory. The ordering of
bits within a segment never changes, and is always the processor’s significance
order as implemented in hardware.</p>
<h2 id="how-to-use-bitfield"><a class="header" href="#how-to-use-bitfield">How to Use <code>BitField</code></a></h2>
<p>You will probably find real use of the <code>BitField</code> trait more educational than
the previous section. It has a very straightforward API, that you can combine
with <code>println!</code>-debugging or your favorite means of viewing memory in order to
observe its actions.</p>
<p>Step one: create any <code>BitSlice</code>-capable buffer. This can be any of the
Rust-native sequence types, or any of the <code>bitvec</code> types.</p>
<pre><code class="language-rust">use bitvec::prelude::*;

let mut data = [0u8; 4];
let bits = data.view_bits_mut::&lt;Msb0&gt;();</code></pre>
<p>Then, narrow the <code>BitSlice</code> to be the region you want to access as storage. It
must be no wider than the integer type you are transferring: <code>BitSlice</code>s whose
length is outside the domain <code>1 ..= M::BITS</code> will panic during <code>.load()</code> or
<code>.store()</code>. The easiest way to narrow a <code>BitSlice</code> (or buffer type that
dereferences to it) is by using range indexing, <code>[start .. end]</code>.</p>
<pre><code class="language-rust"><span class="boring">use bitvec::prelude::*;
</span><span class="boring">let bits = bits![mut u8, Msb0; 0; 32];
</span>bits[10 ..][.. 13].store_be::&lt;u16&gt;(0x765);
assert_eq!(bits[10 .. 23].load_be::&lt;u16&gt;(), 0x765);

bits[10 .. 23].store_le::&lt;u16&gt;(0x432);
assert_eq!(bits[10 .. 23].load_le::&lt;u16&gt;(), 0x432);</code></pre>
<p>That’s the entire API. <code>.store()</code> truncates the stored value to the width of the
receiving <code>BitSlice</code>, and <code>.load()</code> sign-extends the loaded value to the width
of the destination register type.</p>
<pre><code class="language-admonish danger">Storing signed integers can be surprisingly fraught: `bitvec` **will not**
attempt to detect and preserve the most-significant sign bit when truncating! If
you store the number `-12i8` (`0b1111_0100`) in a 4-bit slot, it will be stored
as `4i8` and reloaded as such! Similarly, storing `12i8` (`0b0000_1100)` in a
4-bit slot will produce a load of `-4i8` (`0b1111_1100`).

Signed integers do not behave like unsigned integers. You are wholly responsible
for ensuring that you remember that allowing negative numbers halves the
magnitude: 4 bits unsigned is `0 .. 16`, but 4 bits signed is `-8 .. 8`.

`bitvec` **only stores bit patterns**. Retaining numerical intelligibility is
**your** responsibility.
</code></pre>
<p>You can see an example that uses the <code>BitField</code> trait to implement an I/O
protocol in the <code>examples/ipv4.rs</code> program in the repository. Use
<code>cargo run --example ipv4</code> to see it in action.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../bitvec/practical-use/collections.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../bitvec/memory-representation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../bitvec/practical-use/collections.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../bitvec/memory-representation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
